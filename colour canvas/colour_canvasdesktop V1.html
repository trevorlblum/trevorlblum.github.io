<!DOCTYPE html>
<!-- 
23/11/2024 pick ok but drag does not drop anything
11/9/2024 getImageData insecure on getImageData.cross origin "Anonymous" fails to clear
          when not building canvas colour patch image. function fillpatch created.
          now need to getimagedata from teststrip, not colourpatch.

10/9/2024 pick needs to set dropcolour as mouseY pos, not default event.clientY
9/9/2024 Drag and drop to blood strip OK. Better to pick with press only, drop with release, redraw strip before drop. Mousemove event in canvas commented out.
8/9/2024 Dragging and dropping to canvas3. Mouse drop coords relative to canvas3 coords.
5/9/2024 Finally got canvas pick pixel colour to work on small canvas fill and text
28/8/2024 "destination is null" still confusing...<p id= fixes error but does nothing. 
27/8/2024 trouble getting text color to change. Forced document.getElementById("notes").style.color='#03f7ff';
27/8/2024 added canvas crosshair cursor on mouse move/press and concatenated readout to 'notes'
26/8/2024 destination is pixel colour. Pick is sometimes strange, mouse is click and hover. Not always the same value.
getImageData replaced by ${imageData[x]} ${imageData[x+1]} ...etc seems to work without getImageData problem (line 62)
-->
<html><title> Coloured canvas </title>
<head>
	<!-- Load plotly.js into the DOM -->
	<script src='https://cdn.plot.ly/plotly-2.34.0.min.js'></script>
        <script src="cie_rgb_converter.js"></script>
</head>

<body>

<canvas id="canvas2" width="50px" height="850px" draggable="true" ondragstart="drag(event)"></canvas>
<canvas id="canvas3" width="780px" height="890px" ondrop="dropit(event)" ondragover="allowDrop(event)"></canvas>


<p id="hoveredColor" 'green'</p>
<p id="selectedColor" 'yellow'</p>

<p id="notes"></p> 
</body>

<script>

const canvas2 = document.getElementById("canvas2");
canvas2.addEventListener("click", (event) => pick(event, selectedColor));
//canvas2 shows picked colour for drag/drop

const ctx2 = canvas2.getContext("2d");
ctx2.fillStyle="orange";
ctx2.fillRect(0,0,50,850);
img2=new Image();
img2.src="one_strip_max.png";
ctx2.drawImage(img2, 0, 0);

const canvas3 = document.getElementById("canvas3");//canvas3 shows reference image
canvas3.addEventListener("click", (event) => pick(event, selectedColor));
const ctx3 = canvas3.getContext("2d");
ctx3.fillStyle="green";
ctx3.fillRect(0,0,650,850);
img=new Image();
img.src="reference.png";
ctx3.drawImage(img, 0, 0);


function allowDrop(ev) {
  ev.preventDefault();
}
function drag(ev){
  data=ev.dataTransfer.getData("text");
  alert("drag invoked data= ",data);
  dropcolour='rgb(255,255,0)';
}

/* unused...
function putimage(){
const img = new Image();
//const canvas = document.getElementById("canvas2");
//const ctx2 = canvas.getContext("2d");
  img.addEventListener("load", () => {
  ctx2.drawImage(img, 0, 0);
  img.style.display = "none";
});
}
*/

function pick(event, destination) {
  const bounding = canvas2.getBoundingClientRect();
  const x = event.clientX - bounding.left;
  const y = event.clientY - bounding.top;
  alert("pick coords "+x+","+y);
  document.getElementById("canvas2").style.cursor="crosshair";
var data=ctx2.getImageData(x,y,1,1).data;   //pick pixel colour at mouse coords
var colour=[data[0],data[1],data[2]];

alert("pixel data "+ data[0]+","+data[1]+","+data[2]);
dropcolour="rgb("+data[0]+","+data[1]+","+data[2]+")"; 
alert("dropcolour="+dropcolour+" Coords "+"x="+x+"y="+y);

//dropcolour='blue';
rgbColor=data[0]<<24||data[1]<<16||data[2]<<8||data[3]; 

//alert("text colour "+'rgb('+data[0]+","+data[1]+","+data[2]+')');
ctx2.fillStyle='rgb('+data[0]+","+data[1]+","+data[2]+')';
ctx2.fillRect(0,0,50,20);

//  destination.style.background = rgbColor;//'destination is null'
//  if(shownotes)destination.textContent = rgbColor;
 return rgbColor;
}

function dropit(ev){
  ev.preventDefault();
  alert("dropit invoked");
  dropX=ev.clientX-180;
  dropY=ev.clientY-30;
  const imgn = new Image(50,50);
  imgn.fillStyle=dropcolor;
  imgn.fillRect(0,0,50,50)
  document.getElementById("canvas2").innerHTML="abcd<br>defgh<br>";
  ctx3.drawImage(imgn, 200, 200);
//dropcolour='green';
  ctx3.fillStyle=dropcolour;
  ctx3.fillRect(dropX,dropY,40,40);
  ctx3.fillStyle='rgb(0,0,0)';
  ctx3.fillRect(dropX+10,dropY+15,15,10);
}
</script>
</html>

